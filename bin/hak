#!/usr/bin/env ruby

require 'rubygems'
require 'commander/import'
require 'yaml'
require 'colorize'

program :name, 'hak'
program :version, '0.3.9'
program :description, 'Hak - start hacking!'

default_command :help

command :setup do |c|
  c.syntax = 'hak setup'
  c.summary = 'sets up the hak environment'
  c.description = 'installs docker and sets up the entire docker based environment along with proxy'
  c.example 'description', 'hak setup'
  c.action do |args, options|

    # if ~/.hak not exists, initialize it
    puts "checking to see if ~/.hak exists".blue
    if !Dir.exists?(File.expand_path('~/.hak'))
      puts "- creating ~/.hak".light_blue
      system "mkdir -p ~/.hak/packages"
    else
      puts "- it exists, skipping".blue
    end

    # if ~/.dinghy not exists, initialize it
    puts "checking to see if ~/.dinghy exists".blue
    if !Dir.exists?(File.expand_path('~/.dinghy'))
      puts "- installing docker, docker-machine, docker-compose, xhyve, wget".light_blue
      # remove existing docker
      system "brew upgrade docker docker-machine docker-compose"
      system "brew tap codekitchen/dinghy"
      system "brew install dinghy"
      system "brew install docker docker-machine docker-compose wget"
      system "brew link --overwrite docker-machine"
      system "brew install docker-machine-driver-xhyve"
      system "sudo chown root:wheel $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve"
      system "sudo chmod u+s $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve"
      system "dinghy create --provider xhyve"

    else
      puts "- it exists, skipping".blue
    end

    # check if Docker env variables are set and from which SHELL
    puts "checking your shell:".blue
    shell = `echo $SHELL`.strip    
    puts "- #{shell} detected".blue

    puts "checking if docker environmental variables are set:".blue
    if shell == '/bin/zsh'
      docker_env_exist = `fgrep "export DOCKER_MACHINE_NAME=dinghy" ~/.zshrc |wc -l`.to_i
      if docker_env_exist == 0
        puts '- not set, type:'.yellow
        puts '  echo "$(dinghy env)" >> ~/.zshrc'
      end
    end

    if shell == '/bin/bash'
      docker_env_exist = `fgrep "export DOCKER_MACHINE_NAME=dinghy" ~/.bashrc |wc -l`.to_i
      if docker_env_exist == 0
        puts '- not set, type:'.yellow
        puts '  echo "$(dinghy env)" >> ~/.bash_profile'
      end
    end    

    puts "to power on hak, type:".yellow
    puts "  hak on"

  end
end

command :on do |c|
  c.syntax = 'hak on'
  c.summary = 'powers on the hak server'
  c.description = 'powers on the hak server'
  c.example 'description', 'hak on'
  c.action do |args, options|
    # start up
    system "dinghy up"
  end
end

command :off do |c|
  c.syntax = 'hak off'
  c.summary = 'shuts off hak server'
  c.description = 'shuts off the hak server'
  c.example 'description', 'hak off'
  c.action do |args, options|
    system "dinghy halt"
  end
end

command :uninstall do |c|
  c.syntax = 'hak destroy'
  c.summary = 'destroys hak server'
  c.description = 'shuts off and destroys the hak server'
  c.example 'description', 'hak destroy'
  c.action do |args, options|
    system "dinghy halt"
    system "dinghy destroy"
    system "rm -rf ~/.hak"
    system "rm -rf ~/.dinghy"
  end
end

command :pull do |c|
  c.syntax = 'hak pull jaequery/honeybadger'
  c.summary = 'downloads framework'
  c.description = ''
  c.example 'description', 'hak pull jaequery/honeybadger'
  c.action do |args, options|

    if !Dir.exists?(File.expand_path("~/.hak"))
      system "mkdir ~/.hak"
    end

    if args.empty?
      repo = "jaequery/honeybadger"
      package_author = "jaequery"
      package = "honeybadger"
      puts "Pulling #{repo}"
    else
      repo = args[0]
      package_author = repo.split("/")[0]
      package = repo.split("/")[1]
    end

    system "cd ~/.hak && rm -rf #{repo} && mkdir -p #{repo} && cd #{repo} && wget https://github.com/#{repo}/archive/master.zip && unzip master.zip && rm -f master.zip && mv #{package}-master/* . && rm -r #{package}-master"
  end
end

command :create do |c|
  c.syntax = 'hak create something.com'
  c.summary = 'creates site'
  c.description = ''
  c.example 'description', 'hak create something.com'
  c.action do |args, options|

    if args.empty?
      puts "ex: hak create something"
    else
      folder = args[0]

      # set default to honebadger
      if args[1].nil?
        repo = "jaequery/honeybadger"
      else
        repo = args[1]
      end

      # download package if not exist
      if !Dir.exists?(File.expand_path("~/.hak/" + repo))
        puts "#{repo} not exists, pulling"
        system "hak pull #{repo}"
      end

      # copies the package from local ~/.hak/[repo] to local folder
      puts "copying ~/.hak/#{repo} to ./#{folder}"
      system "cp -Rfp ~/.hak/#{repo} #{folder}"

      # rename virtual host to app name
      file_path = "#{folder}/docker-compose.yml"
      file = File.open(file_path, "r+")
      content = file.read
      host = "#{folder}.docker"
      new_content = content.gsub(/VIRTUAL_HOST=(.*?)\n/, "VIRTUAL_HOST=#{host}\n")
      File.write(file_path, new_content)
      puts "set VIRTUAL_HOST of http://#{host}/"

      puts "now type:"
      puts "cd #{folder}"
      puts "hak up"

    end

  end
end



command :start do |c|
  c.syntax = 'hak start'
  c.summary = 'starts up site'
  c.description = 'this starts up the website'
  c.example 'description', 'hak start'
  c.action do |args, options|
    run "docker-compose up -d && docker-compose logs -f"
  end
end

command :stop do |c|
  c.syntax = 'hak stop'
  c.summary = 'stops site'
  c.description = 'stops the site'
  c.example 'description', 'hak stop'
  c.action do |args, options|
    run "docker-compose stop"
  end
end

command :restart do |c|
  c.syntax = 'hak restart'
  c.summary = 'restarts site'
  c.description = 'restarts the site'
  c.example 'description', 'hak restart'
  c.action do |args, options|
    run "docker-compose stop"
    run "docker-compose up -d && docker-compose logs -f"
  end
end

command :logs do |c|
  c.syntax = 'hak logs'
  c.summary = 'shows the application logs'
  c.description = ''
  c.example 'description', 'hak logs'
  c.action do |args, options|
    run "docker-compose logs -f"
  end
end

command :ssh do |c|

  c.syntax = 'hak ssh'
  c.summary = 'ssh to your app'
  c.description = ''
  c.example 'description', 'hak ssh [app]'
  c.action do |args, options|

    file_name = 'docker-compose.yml'
    config_options = YAML.load_file(file_name)
    app = ''
    apps = []
    config_options.each do |key, value|
        apps << key
    end

    if args.empty?
      puts "choose one:"
      puts apps
      #app = apps[0]
    else
      app = args[0]
      run "docker-compose run #{app} bash"
    end

  end

end

command :ps do |c|
  c.syntax = 'hak ps'
  c.summary = 'lists your running websites'
  c.description = ''
  c.example 'description', 'hak ps'
  c.action do |args, options|
    container_names = run('docker ps --format "{{.Names}}"', true)
    lines = container_names.lines
    dinghy_running = false
    sites = lines.map do |line|
      name = line.split('_')[0]
      if name == 'dinghy'
        dinghy_running = true
        "proxy"
      else
        name
      end
    end

    if dinghy_running == true
      puts sites.uniq
    else
      puts "hak is off, turn it on first by typing:"
      puts "hak on"
    end

  end
end

command :upgrade do |c|
  c.syntax = 'hak upgrade'
  c.summary = 'upgrades hak and dinghy'
  c.description = ''
  c.example 'description', 'hak upgrade'
  c.action do |args, options|
    run "dinghy upgrade"
  end
end


def run(command, hide=false)
  exec = "eval $(dinghy env) && #{command}"

  if hide
    res = `#{exec}`
  else
    res = system exec
  end

  return res
end
