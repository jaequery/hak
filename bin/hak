#!/usr/bin/env ruby

require 'rubygems'
require 'commander/import'
require 'yaml'
require 'colorize'
require 'highline'

program :name, 'hak'
program :version, '0.5.3'
program :description, 'Hak - A Docker powered website manager for OSX'

default_command :help

command :install do |c|
  c.syntax = 'hak install'
  c.summary = 'installs the hak environment'
  c.description = 'installs docker and sets up the entire docker based environment along with proxy'
  c.example 'description', 'hak install'
  c.action do |args, options|

    # if ~/.hak not exists, initialize it
    puts "checking to see if ~/.hak exists".blue
    if !Dir.exists?(File.expand_path('~/.hak'))
      puts "- creating ~/.hak".blue
      system "mkdir -p ~/.hak/packages"

      # install required dependencies 
      puts "- setting up docker, docker-machine, docker-compose, xhyve, wget from brew".blue

      # re-install docker
      system "brew tap codekitchen/dinghy"
      system "brew install dinghy docker docker-machine docker-compose wget docker-machine-driver-xhyve"
      system "brew upgrade dinghy docker docker-machine docker-compose wget docker-machine-driver-xhyve"
      system "brew unlink dinghy docker docker-machine docker-compose wget docker-machine-driver-xhyve"
      system "brew link dinghy docker docker-machine docker-compose wget docker-machine-driver-xhyve"
      system "sudo chown root:wheel $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve"
      system "sudo chmod u+s $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve"
      system "dinghy create --provider xhyve"

    else
      puts "- it exists, skipping".blue
    end
  
    # check if docker is running
    check_docker

    # check if env is set
    check_env    

  end
end

command :uninstall do |c|
  c.syntax = 'hak destroy'
  c.summary = 'destroys hak server'
  c.description = 'shuts off and destroys the hak server'
  c.example 'description', 'hak destroy'
  c.action do |args, options|
    system "dinghy halt"
    system "dinghy destroy"
    system "rm -rf ~/.hak"
    system "rm -rf ~/.dinghy"
  end
end

command :on do |c|
  c.syntax = 'hak on'
  c.summary = 'powers on the hak server'
  c.description = 'powers on the hak server'
  c.example 'description', 'hak on'
  c.action do |args, options|
    if check_env

      if check_proxy
        system "dinghy start"
      end
            
    end
  end
end

command :off do |c|
  c.syntax = 'hak off'
  c.summary = 'shuts off hak server'
  c.description = 'shuts off the hak server'
  c.example 'description', 'hak off'
  c.action do |args, options|
    system "dinghy stop"
  end
end

command :clone do |c|
  c.syntax = 'hak clone jaequery/react-starter'
  c.summary = 'clones github repo'
  c.description = ''
  c.example 'description', 'hak clone jaequery/react-starter'
  c.action do |args, options|

    if args.empty?
      puts "for more hak ready packages, check out https://hak.sh/"
      puts "type one of the following to get started: "
      puts "hak clone jaequery/react-starter".yellow
      puts "hak clone jaequery/honeybadger".yellow
      puts " "
      
    else
      repo = args[0]      
      folder = args[1]
      package_author = repo.split("/")[0]
      package = repo.split("/")[1]

      # if second argument not passed, it uses the git repo's project name
      if folder.nil?
        folder = package
      end

      # downloads package from github
      system "mkdir -p #{folder} && cd #{folder} && wget https://github.com/#{repo}/archive/master.zip && unzip master.zip && rm -f master.zip && mv #{package}-master/* #{package}-master/.* . && rm -r #{package}-master"

      # rename virtual host to app name
      file_path = "#{folder}/docker-compose.yml"
      file = File.open(file_path, "r+")
      content = file.read
      host = "#{folder}.docker"
      new_content = content.gsub(/VIRTUAL_HOST=(.*?)\n/, "VIRTUAL_HOST=#{host}\n")
      File.write(file_path, new_content)    

      puts "now type:"
      puts "cd #{folder}".yellow
      puts "hak start".yellow
      puts "site should be viewable at http://#{host}/".green

    end

  end
end

command :start do |c|
  c.syntax = 'hak start'
  c.summary = 'starts up site'
  c.description = 'this starts up the website'
  c.example 'description', 'hak start'
  c.action do |args, options|
    check_docker
    run "docker-compose up -d && docker-compose logs -f"
  end
end

command :stop do |c|
  c.syntax = 'hak stop'
  c.summary = 'stops site'
  c.description = 'stops the site'
  c.example 'description', 'hak stop'
  c.action do |args, options|
    check_docker
    run "docker-compose stop"
  end
end

command :restart do |c|
  c.syntax = 'hak restart'
  c.summary = 'restarts site'
  c.description = 'restarts the site'
  c.example 'description', 'hak restart'
  c.action do |args, options|
    check_docker
    run "docker-compose stop"
    run "docker-compose up -d && docker-compose logs -f"
  end
end

command :rm do |c|
  c.syntax = 'hak rm'
  c.summary = 'deletes docker containers for the project'
  c.description = 'deletes docker containers for the project'
  c.example 'description', 'hak rm'
  c.action do |args, options|
    check_docker
    run "docker-compose stop && docker-compose rm -f --all"
  end
end

command :logs do |c|
  c.syntax = 'hak logs'
  c.summary = 'shows the application logs'
  c.description = ''
  c.example 'description', 'hak logs'
  c.action do |args, options|
    check_docker
    run "docker-compose logs -f"
  end
end

command :ssh do |c|

  c.syntax = 'hak ssh'
  c.summary = 'ssh to your app'
  c.description = ''
  c.example 'description', 'hak ssh [app]'
  c.action do |args, options|
    check_docker

    file_name = 'docker-compose.yml'
    config_options = YAML.load_file(file_name)
    app = ''
    apps = []
    config_options.each do |key, value|
        apps << key
    end

    if args.empty?
      puts "choose one:"
      puts apps
      #app = apps[0]
    else
      app = args[0]
      run "docker-compose run #{app} bash"
    end

  end

end

command :ps do |c|
  c.syntax = 'hak ps'
  c.summary = 'lists your running websites'
  c.description = ''
  c.example 'description', 'hak ps'
  c.action do |args, options|
    check_docker

    container_names = run('docker ps --format "{{.Names}}"', true)
    lines = container_names.lines
    dinghy_running = false
    sites = lines.map do |line|
      name = line.split('_')[0]
      if name == 'dinghy'
        dinghy_running = true
        "proxy"
      else
        name
      end
    end

    if dinghy_running == true
      puts sites.uniq
    else
      check_docker
    end

  end
end

command :upgrade do |c|
  c.syntax = 'hak upgrade'
  c.summary = 'upgrades hak and dinghy'
  c.description = ''
  c.example 'description', 'hak upgrade'
  c.action do |args, options|
    system "gem update hak"
    run "dinghy upgrade"
  end
end

command :deploy do |c|
  c.syntax = 'hak deploy jae@someserver.com'
  c.summary = 'deploys current site'
  c.description = ''
  c.example 'description', 'hak deploy jae@someserver.com'
  c.action do |args, options|

    dest = args[0]
    dest_docker_installed = true

    if args.empty?
      puts "ex: hak deploy jae@someserver.com"
    else

      # get app name, make sure hak deploy is run from root of your app
      pwd = `pwd`
      dirs = pwd.split("/")
      app = dirs[dirs.length - 1].strip

      # check if docker-compose-production.yml is there
      res = `ls -l |grep docker-compose-production.yml`
      if res == ""
        puts "docker-compose-production file not exists".red
        puts "copying docker-compose.yml to docker-compose-production.yml".blue
        domain = ask "what domain do you want to use? ex) myawesomesite.com".green
        puts "#{domain} set in docker-compose-production.yml"
        system "cp docker-compose.yml docker-compose-production.yml"

        # rename virtual host to new domain name
        file_path = "docker-compose-production.yml"
        file = File.open(file_path, "r+")
        content = file.read
        host = domain
        new_content = content.gsub(/VIRTUAL_HOST=(.*?)\n/, "VIRTUAL_HOST=#{host}\n")
        File.write(file_path, new_content)

      end

      # check if docker is installed
      res = `ssh #{dest} which docker`.strip
      if res == ""
        dest_docker_installed = false    
      end

      # check if docker-compose is installed
      res = `ssh #{dest} which docker-compose`.strip
      if res == ""
        dest_docker_installed = false    
      end      


      # if docker and/or docker-compose is not installed in dest server, install it
      if dest_docker_installed == false
        res = `ssh #{dest} "curl -s https://gist.githubusercontent.com/jaequery/d61ce5371068bc4b386e80b120e8f217/raw/6f14fb1a373335606e86e76627a2debfb8737ab3/install_latest_docker_compose.sh | bash /dev/stdin"`
      end

      # add user to docker group if not root
      user = `ssh #{dest} whoami`.strip
      if res != "root"
        system "ssh #{dest} sudo usermod -aG docker #{user}"
      end

      # if jwilder/nginx-proxy is not running, run it
      res = `ssh #{dest} docker ps |grep jwilder/nginx-proxy`.strip
      if res == ""
        res = `ssh #{dest} "docker run -d --restart=always -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro --name=proxy jwilder/nginx-proxy"`
      end

      # deploy to dest
      #res = `rsync -avzr ../#{app} #{dest}:~/sites/` 
      #res = `ssh #{dest} \"cd ~/sites/#{app} && docker-compose stop && docker-compose up && docker-compose logs -f\"`
      puts "rsyncing from ../#{app} to #{dest}:~/sites/ ... ".blue
      res = `rsync -avzr ../#{app} #{dest}:~/sites/`
      puts "rsync done".blue

      puts "running docker-compose -f docker-compose-production.yml up".blue
      res = `ssh #{dest} "cd ~/sites/#{app} && docker-compose stop && docker-compose -f docker-compose-production.yml up && docker-compose logs"`
      puts "all up and running!".blue
      
    end

  end
end


def run(command, hide=false)
  exec = "#{command}"

  if hide
    res = `#{exec}`
  else
    res = system exec
  end

  return res
end

def check_docker

  res = `dinghy status`
  if res.include? "VM: stopped"
    running = false
    puts "docker not running or stopped"
    puts "type this to power it on:"
    puts "hak on".yellow
    abort
  else
    running = true
  end

  return running
end

def check_proxy
  res = `dinghy status`
  if res.include? "PROXY: stopped"
    # restarting seems to sometimes solve this issue
    system "dinghy restart"
    return false
  end
  return true
end

def check_env  
  docker_machine_name = `echo $DOCKER_MACHINE_NAME`.strip
  if docker_machine_name == "" || docker_machine_name != "dinghy"
    puts "To connect the Docker client to the Docker daemon, please set these env variables, type:"
    puts "$(dinghy env)".yellow
    puts "To permanently add this to your shell type:  ~/.bashrc"
    output_env
    return false
  end
  return true
end

def output_env

  shell = `echo $SHELL`.strip

  if shell == '/bin/zsh'
    docker_env_exist = `fgrep "export DOCKER_MACHINE_NAME=dinghy" ~/.zshrc |wc -l`.to_i
    if docker_env_exist == 0
      puts "echo '$(dinghy env)' >> ~/.zshrc".yellow
    end
  end

  if shell == '/bin/bash'
    docker_env_exist = `fgrep "export DOCKER_MACHINE_NAME=dinghy" ~/.bash_profile |wc -l`.to_i
    if docker_env_exist == 0
      puts "echo '$(dinghy env)' >> ~/.bash_profile".yellow
    end
  end
end